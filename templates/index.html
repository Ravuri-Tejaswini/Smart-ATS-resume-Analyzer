<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart ATS â€“ AI Resume Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <!-- Chart.js for Score Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        
        .gradient-text {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .drag-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .drag-area.active {
            border-color: #6366f1;
            background-color: #eef2ff;
        }

        /* Loading Animation */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #e2e8f0;
            border-bottom-color: #6366f1;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Fade In Animation */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Navbar / Status Bar -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-indigo-600 text-white p-2 rounded-lg">
                    <i class="fa-solid fa-layer-group"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl tracking-tight">Smart ATS</h1>
                    <p class="text-[10px] text-slate-500 uppercase tracking-wider font-semibold">AI Resume Analyzer</p>
                </div>
            </div>
            
            <!-- Connection Status -->
            <div id="connectionStatus" class="flex items-center gap-2 px-3 py-1 rounded-full bg-slate-100 text-xs font-medium text-slate-500 transition-colors duration-300">
                <span class="w-2 h-2 rounded-full bg-slate-400" id="statusDot"></span>
                <span id="statusText">Connecting...</span>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        
        <!-- Header Section -->
        <div class="text-center mb-10">
            <h2 class="text-3xl md:text-4xl font-bold mb-3">Optimize Your <span class="gradient-text">Career Path</span></h2>
            <p class="text-slate-500 max-w-2xl mx-auto">Upload your resume and the job description to get an instant AI-powered analysis, ATS score, and tailored improvement suggestions.</p>
        </div>

        <!-- Input Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            
            <!-- Left Column: Resume Upload -->
            <div class="glass-card rounded-2xl p-6 shadow-sm hover:shadow-md transition-shadow">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg text-slate-800 flex items-center gap-2">
                        <i class="fa-regular fa-file-pdf text-indigo-500"></i> Resume
                    </h3>
                    <span class="text-xs font-medium text-slate-400 bg-slate-100 px-2 py-1 rounded">PDF / DOCX / TXT</span>
                </div>

                <!-- Drag & Drop Area -->
                <div id="dropArea" class="drag-area rounded-xl h-48 flex flex-col items-center justify-center cursor-pointer relative group bg-slate-50/50">
                    <div class="text-center p-4 transition-transform group-hover:scale-105">
                        <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-3 group-hover:text-indigo-500 transition-colors"></i>
                        <p class="text-sm font-medium text-slate-700">Click to upload or drag & drop</p>
                        <p class="text-xs text-slate-400 mt-1">Maximum file size 5MB</p>
                    </div>
                    <input type="file" id="resumeFile" class="hidden" accept=".pdf,.docx,.txt">
                    
                    <!-- File Preview (Hidden initially) -->
                    <div id="filePreview" class="hidden absolute inset-0 bg-white rounded-xl flex flex-col items-center justify-center z-10 border-2 border-indigo-100">
                        <div class="bg-indigo-50 p-3 rounded-full mb-2">
                            <i class="fa-solid fa-file-lines text-indigo-600 text-xl"></i>
                        </div>
                        <p id="fileName" class="font-medium text-sm text-slate-700 max-w-[80%] truncate">resume.pdf</p>
                        <button id="removeFile" class="mt-2 text-xs text-red-500 hover:text-red-700 font-medium hover:underline">Remove file</button>
                    </div>
                </div>

                <!-- Manual Text Paste Fallback (Collapsible) -->
                <div class="mt-4">
                    <button onclick="toggleTextPaste()" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium flex items-center gap-1">
                        <i class="fa-solid fa-font"></i> Or paste text directly
                    </button>
                    <textarea id="resumeText" class="hidden w-full mt-2 h-32 p-3 text-sm bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none resize-none transition-all" placeholder="Paste resume content here..."></textarea>
                </div>
            </div>

            <!-- Right Column: Job Description & Email -->
            <div class="glass-card rounded-2xl p-6 shadow-sm hover:shadow-md transition-shadow flex flex-col justify-between">
                <div>
                    <h3 class="font-semibold text-lg text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-briefcase text-indigo-500"></i> Job Details
                    </h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Job Description</label>
                        <textarea id="jobDescription" class="w-full h-32 p-3 text-sm bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none resize-none transition-all" placeholder="Paste the job description here..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Email (Optional)</label>
                        <input type="email" id="email" class="w-full p-2.5 text-sm bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="you@example.com">
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 mt-6">
                    <button onclick="clearInputs()" class="flex-1 px-4 py-2.5 border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 font-medium transition-colors text-sm">
                        Clear
                    </button>
                    <button onclick="analyzeResume()" id="analyzeBtn" class="flex-[2] px-4 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-md shadow-indigo-200 font-medium transition-all transform active:scale-95 text-sm flex items-center justify-center gap-2">
                        <span>Analyze Resume</span>
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingSection" class="hidden text-center py-12">
            <span class="loader"></span>
            <p class="text-slate-500 mt-4 font-medium animate-pulse">Analyzing your profile against 50+ ATS parameters...</p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden fade-in space-y-8">
            
            <!-- Top Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Score Card -->
                <div class="glass-card p-6 rounded-2xl shadow-sm text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-indigo-500"></div>
                    <h4 class="text-slate-500 font-medium text-sm mb-4 uppercase tracking-wider">ATS Compatibility Score</h4>
                    <div class="relative w-32 h-32 mx-auto">
                        <canvas id="scoreChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center flex-col">
                            <span id="scoreDisplay" class="text-3xl font-bold text-slate-800">0%</span>
                        </div>
                    </div>
                    <p id="scoreVerdict" class="text-sm font-medium mt-2 text-indigo-600">Calculating...</p>
                </div>

                <!-- Match Details -->
                <div class="glass-card p-6 rounded-2xl shadow-sm col-span-1 md:col-span-2 flex flex-col justify-center">
                    <h4 class="text-slate-800 font-bold text-lg mb-4">Match Analysis</h4>
                    
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-slate-600">Skills Match</span>
                            <span id="skillsMatchVal" class="font-bold text-slate-800">0%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2.5">
                            <div id="skillsBar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>

                    <div>
                        <h5 class="text-sm font-medium text-slate-700 mb-2">Missing Keywords</h5>
                        <div id="missingKeywords" class="flex flex-wrap gap-2">
                            <!-- Tags will be injected here -->
                            <span class="text-xs text-slate-400 italic">Analysis required</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Report -->
            <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-indigo-500">
                <h3 class="font-bold text-lg text-slate-800 mb-4">Improvement Plan</h3>
                <ul id="suggestionsList" class="space-y-3 text-sm text-slate-600">
                    <!-- List Items will be injected here -->
                </ul>
            </div>

            <!-- Download Action -->
            <div class="text-center pb-8">
                <button onclick="downloadReport()" class="bg-slate-800 text-white px-6 py-3 rounded-xl hover:bg-slate-900 transition-colors shadow-lg flex items-center gap-2 mx-auto">
                    <i class="fa-solid fa-download"></i> Download Full Report
                </button>
            </div>

        </div>

    </main>

    <footer class="bg-white border-t border-slate-200 py-6 mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center text-slate-400 text-sm">
            &copy; 2026 Smart ATS Analyzer. Powered by Gemini AI.
        </div>
    </footer>

    <script>
        // --- 1. State & Elements ---
        const fileInput = document.getElementById('resumeFile');
        const dropArea = document.getElementById('dropArea');
        const filePreview = document.getElementById('filePreview');
        const fileNameDisplay = document.getElementById('fileName');
        const resumeTextArea = document.getElementById('resumeText');
        const jdInput = document.getElementById('jobDescription');
        const connectionStatus = document.getElementById('connectionStatus');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        let scoreChart = null;

        // --- 2. Backend Health Check ---
        async function checkBackend() {
            try {
                // We ping the home route since it exists
                const response = await fetch('/');
                if (response.ok) {
                    statusDot.classList.replace('bg-slate-400', 'bg-green-500');
                    statusText.textContent = "Backend Connected";
                    statusText.classList.replace('text-slate-500', 'text-green-600');
                    connectionStatus.classList.add('bg-green-50');
                }
            } catch (e) {
                statusDot.classList.replace('bg-slate-400', 'bg-red-500');
                statusText.textContent = "Server Offline";
                statusText.classList.replace('text-slate-500', 'text-red-600');
                connectionStatus.classList.add('bg-red-50');
            }
        }
        window.onload = checkBackend;

        // --- 3. Drag & Drop Logic ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('active'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('active'), false);
        });

        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFiles);
        document.getElementById('removeFile').addEventListener('click', (e) => {
            e.stopPropagation();
            resetFile();
        });

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles({ target: { files: files } });
        }

        function handleFiles(e) {
            const file = e.target.files[0];
            if (file) {
                fileNameDisplay.textContent = file.name;
                filePreview.classList.remove('hidden');
                
                // If it's a text file, we can read it directly
                if (file.type === "text/plain") {
                    const reader = new FileReader();
                    reader.onload = (e) => { resumeTextArea.value = e.target.result; };
                    reader.readAsText(file);
                } else {
                    // For PDF/Docx, we currently simulate or wait for backend PDF parsing
                    // In a real app, you'd upload this file via FormData
                    resumeTextArea.value = `[File attached: ${file.name}]`; 
                }
            }
        }

        function resetFile() {
            fileInput.value = '';
            filePreview.classList.add('hidden');
            resumeTextArea.value = '';
        }

        function toggleTextPaste() {
            resumeTextArea.classList.toggle('hidden');
            resumeTextArea.focus();
        }

        function clearInputs() {
            resetFile();
            resumeTextArea.value = '';
            jdInput.value = '';
            document.getElementById('email').value = '';
            document.getElementById('resultsSection').classList.add('hidden');
        }

        // --- 4. Analysis Logic ---
        async function analyzeResume() {
            const jd = jdInput.value.trim();
            let resume = resumeTextArea.value.trim();
            const file = fileInput.files[0];

            if (!jd) {
                alert("Please enter a Job Description.");
                return;
            }
            if (!resume && !file) {
                alert("Please upload a resume or paste text.");
                return;
            }

            // Check if backend connected
            if (statusText.textContent === "Server Offline") {
                alert("Cannot connect to backend server. Please ensure Flask is running.");
                return;
            }

            // UI Loading
            const btn = document.getElementById('analyzeBtn');
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Processing...`;
            btn.disabled = true;
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');

            try {
                // We construct a specific prompt to force the AI to return JSON
                // This allows us to use your existing generic /chat endpoint!
                const prompt = `
                    Act as an ATS (Applicant Tracking System) Expert. 
                    I will provide a Job Description and a Resume. 
                    
                    Your task:
                    1. Evaluate the resume against the JD.
                    2. Provide a match score (0-100).
                    3. List missing keywords.
                    4. Provide 3-4 specific improvement suggestions.
                    
                    CRITICAL: RETURN ONLY JSON. NO MARKDOWN. NO PREAMBLE.
                    Format:
                    {
                        "score": number,
                        "skills_match": number,
                        "missing_keywords": ["word1", "word2"],
                        "suggestions": ["tip1", "tip2"]
                    }

                    JOB DESCRIPTION:
                    ${jd}

                    RESUME CONTENT:
                    ${resume || "File Name: " + (file ? file.name : "Unknown")}
                `;

                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: prompt })
                });

                const data = await response.json();
                
                // Parse the text reply as JSON (Gemini sometimes wraps in ```json ... ```)
                let cleanJson = data.reply.replace(/```json/g, '').replace(/```/g, '').trim();
                const result = JSON.parse(cleanJson);

                renderResults(result);

            } catch (error) {
                console.error(error);
                alert("Analysis failed. Please try again. (If using a PDF file without text fallback, the backend may not be reading it yet).");
            } finally {
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
                document.getElementById('loadingSection').classList.add('hidden');
            }
        }

        // --- 5. Rendering Results ---
        function renderResults(data) {
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // 1. Score Chart
            initChart(data.score);
            document.getElementById('scoreDisplay').textContent = `${data.score}%`;
            document.getElementById('scoreVerdict').textContent = data.score > 75 ? "Excellent Match" : (data.score > 50 ? "Good Potential" : "Needs Improvement");

            // 2. Skills Bar
            document.getElementById('skillsMatchVal').textContent = `${data.skills_match}%`;
            document.getElementById('skillsBar').style.width = `${data.skills_match}%`;

            // 3. Missing Keywords
            const keywordsContainer = document.getElementById('missingKeywords');
            keywordsContainer.innerHTML = '';
            if (data.missing_keywords && data.missing_keywords.length > 0) {
                data.missing_keywords.forEach(kw => {
                    const tag = document.createElement('span');
                    tag.className = "px-2 py-1 bg-red-50 text-red-600 rounded text-xs font-medium border border-red-100";
                    tag.textContent = kw;
                    keywordsContainer.appendChild(tag);
                });
            } else {
                keywordsContainer.innerHTML = '<span class="text-green-600 text-sm">No critical keywords missing!</span>';
            }

            // 4. Suggestions
            const list = document.getElementById('suggestionsList');
            list.innerHTML = '';
            data.suggestions.forEach(sugg => {
                const li = document.createElement('li');
                li.className = "flex gap-2 items-start";
                li.innerHTML = `<i class="fa-solid fa-check-circle text-indigo-500 mt-1 flex-shrink-0"></i> <span>${sugg}</span>`;
                list.appendChild(li);
            });
            
            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function initChart(score) {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            
            if (scoreChart) scoreChart.destroy();

            scoreChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Match', 'Gap'],
                    datasets: [{
                        data: [score, 100 - score],
                        backgroundColor: ['#4f46e5', '#e2e8f0'],
                        borderWidth: 0,
                        cutout: '85%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }

        function downloadReport() {
            alert("This feature would generate a PDF report of the analysis. (Requires backend implementation)");
        }
    </script>
</body>
</html>
